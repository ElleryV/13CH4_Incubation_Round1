---
title: "CH4_CO2_fluxes"
author: "Ellery Vaughan"
date: "2025-10-15"
output:
  html_document:
    code_folding: hide
    toc: yes
    toc_depth: 3$
    toc_float: no
    df_print: kable 
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

**Script Notes**
Script to make figures for CH4 and CO2 fluxes for the pH and H2O experiments 
Flux method presented here is T2 - T1 (not 30 mL sample collection dilution corrected) 

Analysis & visualization workflow:
✅ Fits models for each group
✅ Runs emmeans + pairwise posthocs
✅ Dynamically generates compact letter displays (with α = 0.10)
✅ Merges those back into your summary data
✅ Plots publication-ready ggplots with letters above the bars

```{r loading libraries}

library(tidyverse)
library(sjPlot)
library(ggtext)
library(ggh4x)
library(readxl)
library(ggforce)
library(emmeans)
library(multcomp)        # not strictly required, but helpful
library(multcompView)    # supplies helper functions used by cld()
library(purrr)
library(dplyr)

```

## pH Experiment 

```{r pH - reading in and cleaning data}

# flux data 
raw1 <- readxl::read_xlsx("data/EV_pH_13CH4Inc_CH4_CO2_10.07.25.xlsx",
                          sheet = "CH4_CO2_fluxes_to_stat")

data1 <- raw1 %>%
  mutate(
    # Convert to factors and relevel
    soil_type    = factor(soil_type, levels = c("Unamended", "Ground Rock")),
    pH_treatment = factor(pH_treatment, levels = c("Dry control", "5", "7", "8")),
    rep          = factor(rep, levels = c("1", "2", "3", "4", "5")),
    jar_type     = as.factor(jar_type)
  )

```

```{r pH - summarizing data for CH4 & CO2 flux figures}

# Selecting only the experimental jars to include in the figure AND removing dry control jars 
exp_jars1 <- data1 %>%
  filter(
    jar_type == "Exp",
    pH_treatment != "Dry control"
  )

summ_exp1 <- exp_jars1 %>%  # Start with the 'exp_jars' dataset and pipe it forward
  group_by(soil_type, pH_treatment) %>% # Group the data by the factors 'soil_type' and 'pH_treatment'
  # All subsequent summary operations will be performed within these groups
 
   summarise(
    across(
      c(ng_CH4_per_g_dry_soil_per_day,ug_CO2_per_g_dry_soil_per_day),  # Select the numeric columns to summarize: initial and final CH4 ppm
      list(
        mean = ~ mean(.x, na.rm = TRUE),  # Compute mean, ignoring NAs
        sd   = ~ sd(.x, na.rm = TRUE),    # Compute standard deviation, ignoring NAs
        n    = ~ n()                      # Count number of rows in the group
      ),
      .names = "{.col}_{.fn}"  
      # Automatically name the new summary columns using the pattern:
      # original column name + "_" + function name
      # e.g., CH4_ppm_INITIAL_mean, CH4_ppm_FINAL_sd
    ),
    .groups = "drop"  # Ungroup the data after summarising so further operations are not grouped
  ) %>% 
  
  # Calculate standard error and relevel factors
  mutate(
    ng_CH4_per_g_dry_soil_per_day_se = ng_CH4_per_g_dry_soil_per_day_sd / sqrt(ng_CH4_per_g_dry_soil_per_day_n),  # Standard error = SD / sqrt(n) for CH4 fluxes
    ug_CO2_per_g_dry_soil_per_day_se   = ug_CO2_per_g_dry_soil_per_day_sd / sqrt(ug_CO2_per_g_dry_soil_per_day_n),  # Standard error = SD / sqrt(n) for CO2 fluxes
    
    # Convert factors to ordered factors with specific levels
    soil_type    = factor(soil_type, levels = c("Unamended", "Ground Rock")),  
    pH_treatment = factor(pH_treatment, levels = c("5", "7", "8"))  
  )

```

### CH4 fluxes (without dry control)

```{r pH exp CH4 fluxes - linear models}

# Fit models for each soil_type and store results
pH_CH4_models <- exp_jars1 %>% 
  group_by(soil_type) %>%                                # group data by soil type
  group_map(~ {                                           # apply function to each group
    lm_fit <- lm(ng_CH4_per_g_dry_soil_per_day ~ pH_treatment, data = .x)   # fit linear model for CH4 initial ppm vs pH_treatment
    list(                                                 # return both model and emmeans results
      model = lm_fit,                                     # store lm model
      emmeans = emmeans(lm_fit, pairwise ~ pH_treatment, level = 0.90)  # get pairwise emmeans for pH_treatment and specify 90% CI
    )
  }, keep = TRUE) %>%                                     # keep soil_type info in output
  set_names(unique(exp_jars$soil_type))                   # name each list element by soil_type

 # all model output 
# CH4_models

# Unamended soils model results 
summary(pH_CH4_models$Unamended$model) # model summary 
anova(pH_CH4_models$Unamended$model) # ANOVA table 
pH_CH4_models$Unamended$emmeans # returns both emmeans and pairwise objects              

# Unamended soils model results 
summary(pH_CH4_models$`Ground Rock`$model) # model summary 
anova(pH_CH4_models$`Ground Rock`$model) # ANOVA table 
pH_CH4_models$`Ground Rock`$emmeans # returns both emmeans and pairwise objects              


```

```{r pH exp CH4 fluxes  - post-hoc pairwise comparisons and dynamically generate letters}

# Generate compact letter display for each soil type
pH_CH4_letters <- map_df(names(pH_CH4_models), function(st) {
  emmeans_res <- pH_CH4_models[[st]]$emmeans$emmeans  # Extract emmeans table
  cld_df <- multcomp::cld(emmeans_res, Letters=letters)    # Generate compact letter display
  cld_df <- as.data.frame(cld_df)                   # Convert to standard data frame
  cld_df$soil_type <- st                            # Add soil type as a column
  cld_df$letters <- cld_df$.group                   # Rename .group column to 'letters'
  cld_df <- cld_df[, c("soil_type", "pH_treatment", "letters")]  # Keep only relevant columns
  return(cld_df)                                    # Return processed data frame
}) %>%
  mutate(
    soil_type = factor(soil_type, levels = c("Unamended", "Ground Rock")),  # Relevel soil_type for plotting
    pH_treatment = factor(pH_treatment, levels = c("5", "7", "8"))  # Relevel pH_treatment
  )

```

```{r pH exp CH4 fluxes  - dynamically assign posthoc pairwise letter positions based on max value per soil type}

pH_CH4_letters <- pH_CH4_letters %>%
  left_join(summ_exp %>% dplyr::select(soil_type, pH_treatment, ng_CH4_per_g_dry_soil_per_day_mean, ng_CH4_per_g_dry_soil_per_day_se),
            by = c("soil_type", "pH_treatment")) %>%
  group_by(soil_type) %>%
  mutate(
    letter_y = ng_CH4_per_g_dry_soil_per_day_mean - ng_CH4_per_g_dry_soil_per_day_se + 0.1*max(ng_CH4_per_g_dry_soil_per_day_mean)
  ) %>%
  ungroup() %>% 
  mutate(
    soil_type = factor(soil_type, levels = c("Unamended", "Ground Rock")),  # Relevel soil_type for plotting
    pH_treatment = factor(pH_treatment, levels = c("5", "7", "8"))  # Relevel pH_treatment
  )

```

```{r pH exp CH4 fluxes  - Create p-value annotations from model summaries}

pH_CH4_pvals <- map_df(names(pH_CH4_models), function(st) {
  model <- pH_CH4_models[[st]]$model                # Extract the lm object
  pval  <- anova(model)$`Pr(>F)`[1]             # Extract the p-value for pH_treatment
  data.frame(
    soil_type = st,                              # Use the soil type name from the list
    label = paste0("p = ", signif(pval, 2))     # Format p-value
  )
}) %>% 
  mutate(
    soil_type = factor(soil_type, levels = c("Unamended", "Ground Rock"))  # Relevel soil_type for plotting
  )

```

```{r pH exp CH4 fluxes  - plot means and lm stats results}

# Plot
pH_CH4_fluxes_means <- ggplot(summ_exp1, 
                              aes(x = pH_treatment, 
                                  y = ng_CH4_per_g_dry_soil_per_day_mean, 
                                  fill = pH_treatment)) +
  geom_col(position = "dodge", color = "black") +
  geom_errorbar(aes(ymin = ng_CH4_per_g_dry_soil_per_day_mean - ng_CH4_per_g_dry_soil_per_day_se,
                    ymax = ng_CH4_per_g_dry_soil_per_day_mean + ng_CH4_per_g_dry_soil_per_day_se),
                width = 0.25, size = 0.3) +
  geom_text(
    data = pH_CH4_letters, 
    aes(x = pH_treatment, 
        y = letter_y, 
        label = letters),
    inherit.aes = FALSE,
    fontface = "bold",
    size = 5
  ) +
  geom_label(
    data = pH_CH4_pvals, 
    aes(x = 1, 
        # y = 7,
        y = max(summ_exp1$ng_CH4_per_g_dry_soil_per_day_mean)*2.5, 
        label = label),
    inherit.aes = FALSE) +
  facet_wrap2(~soil_type, strip = strip_themed(
    background_x = elem_list_rect(fill = rep("gray95", 2)),
    text_x = elem_list_text(color = rep("black", 2))
  )) +
  scale_fill_manual(values = c("#66c2a5", "#fc8d62", "#8da0cb")) +
  theme_bw() +
  labs(title = (bquote(CH[4]~Fluxes~with~pH~Treatment) ),
       x = "pH Treatment",
       # y = bquote(CH[4]~(ppm)),
       fill = "Soil pH Treatment") +
  ylab(bquote(ng~CH[4]~g~soil^-1~day^-1) ) +
  theme(
    plot.title = element_text(size = 20),
    axis.title = element_text(size = 14),
    axis.text = element_text(size = 12),
    legend.title = element_text(size = 14),
    legend.text = element_text(size = 12)
  ) 

pH_CH4_fluxes_means

ggsave(plot = pH_CH4_fluxes_means, filename = "figures/pH/fluxes/pH_CH4_fluxes_means.png", width = 8.5, height = 5)

```

### CO2 fluxes (without dry control)

```{r pH exp CO2 fluxes - linear models}

# Fit models for each soil_type and store results
pH_CO2_models <- exp_jars1 %>% 
  group_by(soil_type) %>%                                # group data by soil type
  group_map(~ {                                           # apply function to each group
    lm_fit <- lm(ug_CO2_per_g_dry_soil_per_day ~ pH_treatment, data = .x)   # fit linear model for CO2 initial ppm vs pH_treatment
    list(                                                 # return both model and emmeans results
      model = lm_fit,                                     # store lm model
      emmeans = emmeans(lm_fit, pairwise ~ pH_treatment, level = 0.90)  # get pairwise emmeans for pH_treatment and specify 90% CI
    )
  }, keep = TRUE) %>%                                     # keep soil_type info in output
  set_names(unique(exp_jars$soil_type))                   # name each list element by soil_type

 # all model output 
# CO2_models

# Unamended soils model results 
summary(pH_CO2_models$Unamended$model) # model summary 
anova(pH_CO2_models$Unamended$model) # ANOVA table 
pH_CO2_models$Unamended$emmeans # returns both emmeans and pairwise objects              

# Unamended soils model results 
summary(pH_CO2_models$`Ground Rock`$model) # model summary 
anova(pH_CO2_models$`Ground Rock`$model) # ANOVA table 
pH_CO2_models$`Ground Rock`$emmeans # returns both emmeans and pairwise objects              


```

```{r pH exp CO2 fluxes - post-hoc pairwise comparisons and dynamically generate letters}

# Generate compact letter display for each soil type
pH_CO2_letters <- map_df(names(pH_CO2_models), function(st) {
  emmeans_res <- pH_CO2_models[[st]]$emmeans$emmeans  # Extract emmeans table
  cld_df <- multcomp::cld(emmeans_res, Letters=letters)    # Generate compact letter display
  cld_df <- as.data.frame(cld_df)                   # Convert to standard data frame
  cld_df$soil_type <- st                            # Add soil type as a column
  cld_df$letters <- cld_df$.group                   # Rename .group column to 'letters'
  cld_df <- cld_df[, c("soil_type", "pH_treatment", "letters")]  # Keep only relevant columns
  return(cld_df)                                    # Return processed data frame
}) %>%
  mutate(
    soil_type = factor(soil_type, levels = c("Unamended", "Ground Rock")),  # Relevel soil_type for plottiug
    pH_treatment = factor(pH_treatment, levels = c("5", "7", "8"))  # Relevel pH_treatment
  )

```

```{r pH exp CO2 fluxes - dynamically assign posthoc pairwise letter positions based on max value per soil type}

pH_CO2_letters <- pH_CO2_letters %>%
  left_join(summ_exp %>% dplyr::select(soil_type, pH_treatment, ug_CO2_per_g_dry_soil_per_day_mean, ug_CO2_per_g_dry_soil_per_day_se),
            by = c("soil_type", "pH_treatment")) %>%
  group_by(soil_type) %>%
  mutate(
    letter_y = ug_CO2_per_g_dry_soil_per_day_mean - ug_CO2_per_g_dry_soil_per_day_se + 0.1*max(ug_CO2_per_g_dry_soil_per_day_mean)
  ) %>%
  ungroup() %>% 
  mutate(
    soil_type = factor(soil_type, levels = c("Unamended", "Ground Rock")),  # Relevel soil_type for plottiug
    pH_treatment = factor(pH_treatment, levels = c("5", "7", "8"))  # Relevel pH_treatment
  )

```

```{r pH exp CO2 fluxes - Create p-value annotations from model summaries}

pH_CO2_pvals <- map_df(names(pH_CO2_models), function(st) {
  model <- pH_CO2_models[[st]]$model                # Extract the lm object
  pval  <- anova(model)$`Pr(>F)`[1]             # Extract the p-value for pH_treatment
  data.frame(
    soil_type = st,                              # Use the soil type name from the list
    label = paste0("p = ", signif(pval, 2))     # Format p-value
  )
}) %>% 
  mutate(
    soil_type = factor(soil_type, levels = c("Unamended", "Ground Rock"))  # Relevel soil_type for plottiug
  )

```

```{r pH exp CO2 fluxes - plot CO2 conc means and lm stats results}

# Plot
pH_CO2_fluxes_means <- ggplot(summ_exp1, aes(x = pH_treatment, y = ug_CO2_per_g_dry_soil_per_day_mean, fill = pH_treatment)) +
  geom_col(position = "dodge", color = "black") +
  geom_errorbar(aes(ymin = ug_CO2_per_g_dry_soil_per_day_mean - ug_CO2_per_g_dry_soil_per_day_se,
                    ymax = ug_CO2_per_g_dry_soil_per_day_mean + ug_CO2_per_g_dry_soil_per_day_se),
                width = 0.25, size = 0.3) +
  geom_text(
    data = pH_CO2_letters, 
    aes(x = pH_treatment, 
        y = letter_y, 
        label = letters),
    inherit.aes = FALSE,
    fontface = "bold",
    size = 5
  ) +
  geom_label(
    data = pH_CO2_pvals, 
    aes(x = 3, 
        # y = 7,
        y = max(summ_exp1$ug_CO2_per_g_dry_soil_per_day_mean)*1.15, 
        label = label),
    inherit.aes = FALSE) +
  facet_wrap2(~soil_type, strip = strip_themed(
    background_x = elem_list_rect(fill = rep("gray95", 2)),
    text_x = elem_list_text(color = rep("black", 2))
  )) +
  scale_fill_manual(values = c("#66c2a5", "#fc8d62", "#8da0cb")) +
  theme_bw() +
  labs(title = (bquote(CO[2]~Fluxes~with~pH~Treatment) ),
       x = "pH Treatment",
       # y = bquote(CO[2]~ug~g^-1~day^-1),
       fill = "Soil pH Treatment") +
    ylab(bquote(ug~CO[2]~g~soil^-1~day^-1) ) +
    theme(
    plot.title = element_text(size = 20),
    axis.title = element_text(size = 14),
    axis.text = element_text(size = 12),
    legend.title = element_text(size = 14),
    legend.text = element_text(size = 12)
  ) 

pH_CO2_fluxes_means

ggsave(plot = pH_CO2_fluxes_means, filename = "figures/pH/fluxes/pH_CO2_fluxes_means.png", width = 8.5, height = 5)


```


## H2O Experiment 

```{r H2O - reading in and cleaning data}

# flux data 
raw2 <- readxl::read_xlsx("data/EV_H2O_13CH4Inc_CH4_CO2_10.14.25.xlsx",
                          sheet = "CH4_CO2_fluxes_to_stat")

data2 <- raw2 %>%
  mutate(
    # Convert to factors and relevel
    soil_type    = factor(soil_type, levels = c("Unamended", "Ground Rock")),
    H2O_treatment = factor(H2O_treatment, levels = c("no","yes")),
    rep          = factor(rep, levels = c("1", "2", "3", "4", "5")),
    jar_type     = as.factor(jar_type)
  )

```

```{r H2O - summarizing data for CH4 & CO2 flux figures}

# Selecting only the experimental jars to include in the figure AND removing dry control jars 
exp_jars2 <- data2 %>%
  filter(
    jar_type == "Exp"
  )

summ_exp2 <- exp_jars2 %>%  # Start with the 'exp_jars' dataset and pipe it forward
  group_by(soil_type, H2O_treatment) %>% # Group the data by the factors 'soil_type' and 'pH_treatment'
  # All subsequent summary operations will be performed within these groups
 
   summarise(
    across(
      c(ng_CH4_per_g_dry_soil_per_day,ug_CO2_per_g_dry_soil_per_day),  # Select the numeric columns to summarize: initial and final CH4 ppm
      list(
        mean = ~ mean(.x, na.rm = TRUE),  # Compute mean, ignoring NAs
        sd   = ~ sd(.x, na.rm = TRUE),    # Compute standard deviation, ignoring NAs
        n    = ~ n()                      # Count number of rows in the group
      ),
      .names = "{.col}_{.fn}"  
      # Automatically name the new summary columns using the pattern:
      # original column name + "_" + function name
      # e.g., CH4_ppm_INITIAL_mean, CH4_ppm_FINAL_sd
    ),
    .groups = "drop"  # Ungroup the data after summarising so further operations are not grouped
  ) %>% 
  
  # Calculate standard error and relevel factors
  mutate(
    ng_CH4_per_g_dry_soil_per_day_se = ng_CH4_per_g_dry_soil_per_day_sd / sqrt(ng_CH4_per_g_dry_soil_per_day_n),  # Standard error = SD / sqrt(n) for CH4 fluxes
    ug_CO2_per_g_dry_soil_per_day_se   = ug_CO2_per_g_dry_soil_per_day_sd / sqrt(ug_CO2_per_g_dry_soil_per_day_n),  # Standard error = SD / sqrt(n) for CO2 fluxes
    
    # Convert factors to ordered factors with specific levels
    soil_type    = factor(soil_type, levels = c("Unamended", "Ground Rock")),  
    H2O_treatment = factor(H2O_treatment, levels = c("no","yes")),  
  )

```

### CH4 fluxes 

```{r H2O exp CH4 fluxes - linear models}

# Fit models for each soil_type and store results
H2O_CH4_models <- exp_jars2 %>% 
  group_by(soil_type) %>%                                # group data by soil type
  group_map(~ {                                           # apply function to each group
    lm_fit <- lm(ng_CH4_per_g_dry_soil_per_day ~ H2O_treatment, data = .x)   # fit linear model for CH4 initial ppm vs pH_treatment
    list(                                                 # return both model and emmeans results
      model = lm_fit,                                     # store lm model
      emmeans = emmeans(lm_fit, pairwise ~ H2O_treatment, level = 0.90)  # get pairwise emmeans for pH_treatment and specify 90% CI
    )
  }, keep = TRUE) %>%                                     # keep soil_type info in output
  set_names(unique(exp_jars$soil_type))                   # name each list element by soil_type

 # all model output 
# CH4_models

# Unamended soils model results 
summary(H2O_CH4_models$Unamended$model) # model summary 
anova(H2O_CH4_models$Unamended$model) # ANOVA table 
H2O_CH4_models$Unamended$emmeans # returns both emmeans and pairwise objects              

# Unamended soils model results 
summary(H2O_CH4_models$`Ground Rock`$model) # model summary 
anova(H2O_CH4_models$`Ground Rock`$model) # ANOVA table 
H2O_CH4_models$`Ground Rock`$emmeans # returns both emmeans and pairwise objects              


```

```{r H2O exp CH4 fluxes - post-hoc pairwise comparisons and dynamically generate letters}

# Generate compact letter display for each soil type
H2O_CH4_letters <- map_df(names(H2O_CH4_models), function(st) {
  emmeans_res <- H2O_CH4_models[[st]]$emmeans$emmeans  # Extract emmeans table
  cld_df <- multcomp::cld(emmeans_res, Letters=letters)    # Generate compact letter display
  cld_df <- as.data.frame(cld_df)                   # Convert to standard data frame
  cld_df$soil_type <- st                            # Add soil type as a column
  cld_df$letters <- cld_df$.group                   # Rename .group column to 'letters'
  cld_df <- cld_df[, c("soil_type", "H2O_treatment", "letters")]  # Keep only relevant columns
  return(cld_df)                                    # Return processed data frame
}) %>%
  mutate(
    soil_type = factor(soil_type, levels = c("Unamended", "Ground Rock")),  # Relevel soil_type for plotting
    H2O_treatment = factor(H2O_treatment, levels = c("no","yes"))  # Relevel pH_treatment
  )

```

```{r H2O exp CH4 fluxes  - dynamically assign posthoc pairwise letter positions based on max value per soil type}

H2O_CH4_letters <- H2O_CH4_letters %>%
  left_join(summ_exp %>% dplyr::select(soil_type, H2O_treatment, ng_CH4_per_g_dry_soil_per_day_mean, ng_CH4_per_g_dry_soil_per_day_se),
            by = c("soil_type", "H2O_treatment")) %>%
  group_by(soil_type) %>%
  mutate(
    letter_y = ng_CH4_per_g_dry_soil_per_day_mean - ng_CH4_per_g_dry_soil_per_day_se + 0.25*max(ng_CH4_per_g_dry_soil_per_day_mean)
  ) %>%
  ungroup() %>% 
  mutate(
    soil_type = factor(soil_type, levels = c("Unamended", "Ground Rock")),  # Relevel soil_type for plotting
     H2O_treatment = factor(H2O_treatment, levels = c("no","yes"))  # Relevel pH_treatment
  )

```

```{r H2O exp CH4 fluxes  - Create p-value annotations from model summaries}

H2O_CH4_pvals <- map_df(names(H2O_CH4_models), function(st) {
  model <- H2O_CH4_models[[st]]$model                # Extract the lm object
  pval  <- anova(model)$`Pr(>F)`[1]             # Extract the p-value for pH_treatment
  data.frame(
    soil_type = st,                              # Use the soil type name from the list
    label = paste0("p = ", signif(pval, 2))     # Format p-value
  )
}) %>% 
  mutate(
    soil_type = factor(soil_type, levels = c("Unamended", "Ground Rock"))  # Relevel soil_type for plotting
  )

```

```{r H2O exp CH4 fluxes  - plot CH4 conc means and lm stats results}

# Plot
H2O_CH4_fluxes_means <- ggplot(summ_exp2, aes(x = H2O_treatment, y = ng_CH4_per_g_dry_soil_per_day_mean, fill = H2O_treatment)) +
  geom_col(position = "dodge", color = "black") +
  geom_errorbar(aes(ymin = ng_CH4_per_g_dry_soil_per_day_mean - ng_CH4_per_g_dry_soil_per_day_se,
                    ymax = ng_CH4_per_g_dry_soil_per_day_mean + ng_CH4_per_g_dry_soil_per_day_se),
                width = 0.25, size = 0.3) +
  geom_text(
    data = H2O_CH4_letters, 
    aes(x = H2O_treatment, 
        y = letter_y, 
        label = letters),
    inherit.aes = FALSE,
    fontface = "bold",
    size = 5
  ) +
  geom_label(
    data = H2O_CH4_pvals, 
    aes(x = 1, 
        # y = 7,
        y = max(summ_exp2$ng_CH4_per_g_dry_soil_per_day_mean)*18, 
        label = label),
    inherit.aes = FALSE) +
  facet_wrap2(~soil_type, strip = strip_themed(
    background_x = elem_list_rect(fill = rep("gray95", 2)),
    text_x = elem_list_text(color = rep("black", 2))
  )) +
  scale_fill_manual(values = c("darkgrey", "#a6cee3")) +
  theme_bw() +
  labs(title = (bquote(CH[4]~Fluxes~with~H2O~Treatment) ),
       x = "H2O Treatment",
       # y = bquote(CH[4]~(ppm)),
       fill = "Soil Water Treatment") +
  ylab(bquote(ng~CH[4]~g~soil^-1~day^-1) ) +
  theme(
    plot.title = element_text(size = 20),
    axis.title = element_text(size = 14),
    axis.text = element_text(size = 12),
    legend.title = element_text(size = 14),
    legend.text = element_text(size = 12)
  ) 

H2O_CH4_fluxes_means

ggsave(plot = H2O_CH4_fluxes_means, filename = "figures/pH/fluxes/H2O_CH4_fluxes_means.png", width = 8.5, height = 5)

```

### CO2 fluxes 

```{r H2O exp CO2 fluxes - linear models}

# Fit models for each soil_type and store results
H2O_CO2_models <- exp_jars2 %>% 
  group_by(soil_type) %>%                                # group data by soil type
  group_map(~ {                                           # apply function to each group
    lm_fit <- lm(ug_CO2_per_g_dry_soil_per_day ~ H2O_treatment, data = .x)   # fit linear model for CO2 initial ppm vs pH_treatment
    list(                                                 # return both model and emmeans results
      model = lm_fit,                                     # store lm model
      emmeans = emmeans(lm_fit, pairwise ~ H2O_treatment, level = 0.90)  # get pairwise emmeans for pH_treatment and specify 90% CI
    )
  }, keep = TRUE) %>%                                     # keep soil_type info in output
  set_names(unique(exp_jars$soil_type))                   # name each list element by soil_type

 # all model output 
# CO2_models

# Unamended soils model results 
summary(H2O_CO2_models$Unamended$model) # model summary 
anova(H2O_CO2_models$Unamended$model) # ANOVA table 
H2O_CO2_models$Unamended$emmeans # returns both emmeans and pairwise objects              

# Unamended soils model results 
summary(H2O_CO2_models$`Ground Rock`$model) # model summary 
anova(H2O_CO2_models$`Ground Rock`$model) # ANOVA table 
H2O_CO2_models$`Ground Rock`$emmeans # returns both emmeans and pairwise objects              


```

```{r H2O exp CO2 fluxes - post-hoc pairwise comparisons and dynamically generate letters}

# Generate compact letter display for each soil type
H2O_CO2_letters <- map_df(names(H2O_CO2_models), function(st) {
  emmeans_res <- H2O_CO2_models[[st]]$emmeans$emmeans  # Extract emmeans table
  cld_df <- multcomp::cld(emmeans_res, Letters=letters)    # Generate compact letter display
  cld_df <- as.data.frame(cld_df)                   # Convert to standard data frame
  cld_df$soil_type <- st                            # Add soil type as a column
  cld_df$letters <- cld_df$.group                   # Rename .group column to 'letters'
  cld_df <- cld_df[, c("soil_type", "H2O_treatment", "letters")]  # Keep only relevant columns
  return(cld_df)                                    # Return processed data frame
}) %>%
  mutate(
    soil_type = factor(soil_type, levels = c("Unamended", "Ground Rock")),  # Relevel soil_type for plottiug
    H2O_treatment = factor(H2O_treatment, levels = c("no","yes"))  # Relevel pH_treatment
  )

```

```{r H2O exp CO2 fluxes  - dynamically assign posthoc pairwise letter positions based on max value per soil type}

H2O_CO2_letters <- H2O_CO2_letters %>%
  left_join(summ_exp %>% dplyr::select(soil_type, H2O_treatment, ug_CO2_per_g_dry_soil_per_day_mean, ug_CO2_per_g_dry_soil_per_day_se),
            by = c("soil_type", "H2O_treatment")) %>%
  group_by(soil_type) %>%
  mutate(
    letter_y = ug_CO2_per_g_dry_soil_per_day_mean + ug_CO2_per_g_dry_soil_per_day_se + 0.1*max(ug_CO2_per_g_dry_soil_per_day_mean)
  ) %>%
  ungroup() %>% 
  mutate(
    soil_type = factor(soil_type, levels = c("Unamended", "Ground Rock")),  # Relevel soil_type for plottiug
     H2O_treatment = factor(H2O_treatment, levels = c("no","yes"))  # Relevel pH_treatment
  )

```

```{r H2O exp CO2 fluxes  - Create p-value annotations from model summaries}

H2O_CO2_pvals <- map_df(names(H2O_CO2_models), function(st) {
  model <- H2O_CO2_models[[st]]$model                # Extract the lm object
  pval  <- anova(model)$`Pr(>F)`[1]             # Extract the p-value for pH_treatment
  data.frame(
    soil_type = st,                              # Use the soil type name from the list
    label = paste0("p = ", signif(pval, 2))     # Format p-value
  )
}) %>% 
  mutate(
    soil_type = factor(soil_type, levels = c("Unamended", "Ground Rock"))  # Relevel soil_type for plottiug
  )

```

```{r H2O exp CO2 fluxes  - plot CO2 conc means and lm stats results}

# Plot
H2O_CO2_fluxes_means <- ggplot(summ_exp2, aes(x = H2O_treatment, y = ug_CO2_per_g_dry_soil_per_day_mean, fill = H2O_treatment)) +
  geom_col(position = "dodge", color = "black") +
  geom_errorbar(aes(ymin = ug_CO2_per_g_dry_soil_per_day_mean - ug_CO2_per_g_dry_soil_per_day_se,
                    ymax = ug_CO2_per_g_dry_soil_per_day_mean + ug_CO2_per_g_dry_soil_per_day_se),
                width = 0.25, size = 0.3) +
  geom_text(
    data = H2O_CO2_letters, 
    aes(x = H2O_treatment, 
        y = letter_y, 
        label = letters),
    inherit.aes = FALSE,
    fontface = "bold",
    size = 5
  ) +
  geom_label(
    data = H2O_CO2_pvals, 
    aes(x = 1, 
        # y = 7,
        y = max(summ_exp2$ug_CO2_per_g_dry_soil_per_day_mean)*1.15, 
        label = label),
    inherit.aes = FALSE) +
  facet_wrap2(~soil_type, strip = strip_themed(
    background_x = elem_list_rect(fill = rep("gray95", 2)),
    text_x = elem_list_text(color = rep("black", 2))
  )) +
  scale_fill_manual(values = c("darkgrey", "#a6cee3")) +
  theme_bw() +
  labs(title = (bquote(CO[2]~Fluxes~with~Water~Treatment) ),
       x = "H2O Treatment",
       # y = bquote(CH[4]~(ppm)),
       fill = "Soil Water Treatment") +
  ylab(bquote(ug~CO[2]~g~soil^-1~day^-1) ) +
  theme(
    plot.title = element_text(size = 20),
    axis.title = element_text(size = 14),
    axis.text = element_text(size = 12),
    legend.title = element_text(size = 14),
    legend.text = element_text(size = 12)
  ) 

H2O_CO2_fluxes_means

ggsave(plot = H2O_CO2_fluxes_means, filename = "figures/pH/fluxes/H2O_CO2_fluxes_means.png", width = 8.5, height = 5)

```

## pH Experiment with wet controls from H2O Experiment

```{r pH & H2O - summarizing data for CH4 & CO2 flux figures}

data1 <- data1 %>% 
    filter(
    jar_type == "Exp",
    pH_treatment != "Dry control"
  )

data2 <- data2 %>% 
    filter(
    jar_type == "Exp",
    H2O_treatment == "yes"
  ) %>% 
  rename(pH_treatment = H2O_treatment) %>% 
  mutate(pH_treatment = recode(pH_treatment, "yes" = "Wet control") ) %>% 
  dplyr::select( -c(CH4_flux_CV,CO2_flux_CV) )

names(data1)
names(data2)

exp_jars <- rbind(data1,data2) %>% 
  mutate(
    soil_type    = factor(soil_type, levels = c("Unamended", "Ground Rock")),  
    pH_treatment = factor(pH_treatment, levels = c("Wet control", "5", "7", "8"))  
  )

summ_exp <- exp_jars %>%  # Start with the 'exp_jars' dataset and pipe it forward
  group_by(soil_type, pH_treatment) %>% # Group the data by the factors 'soil_type' and 'pH_treatment'
  # All subsequent summary operations will be performed within these groups
 
   summarise(
    across(
      c(ng_CH4_per_g_dry_soil_per_day,ug_CO2_per_g_dry_soil_per_day),  # Select the numeric columns to summarize: initial and final CH4 ppm
      list(
        mean = ~ mean(.x, na.rm = TRUE),  # Compute mean, ignoring NAs
        sd   = ~ sd(.x, na.rm = TRUE),    # Compute standard deviation, ignoring NAs
        n    = ~ n()                      # Count number of rows in the group
      ),
      .names = "{.col}_{.fn}"  
      # Automatically name the new summary columns using the pattern:
      # original column name + "_" + function name
      # e.g., CH4_ppm_INITIAL_mean, CH4_ppm_FINAL_sd
    ),
    .groups = "drop"  # Ungroup the data after summarising so further operations are not grouped
  ) %>% 
  
  # Calculate standard error and relevel factors
  mutate(
    ng_CH4_per_g_dry_soil_per_day_se = ng_CH4_per_g_dry_soil_per_day_sd / sqrt(ng_CH4_per_g_dry_soil_per_day_n),  # Standard error = SD / sqrt(n) for CH4 fluxes
    ug_CO2_per_g_dry_soil_per_day_se   = ug_CO2_per_g_dry_soil_per_day_sd / sqrt(ug_CO2_per_g_dry_soil_per_day_n),  # Standard error = SD / sqrt(n) for CO2 fluxes
    
    # Convert factors to ordered factors with specific levels
    soil_type    = factor(soil_type, levels = c("Unamended", "Ground Rock")),  
    pH_treatment = factor(pH_treatment, levels = c("Wet control", "5", "7", "8"))  
  )

```

### CH4 fluxes (WITH wet control)

```{r pH & H2O exps CH4 fluxes - linear models}

# Fit models for each soil_type and store results
pH_H2O_CH4_models <- exp_jars %>% 
  group_by(soil_type) %>%                                # group data by soil type
  group_map(~ {                                           # apply the following code to each soil_type group
    lm_fit <- lm(ng_CH4_per_g_dry_soil_per_day ~ pH_treatment, data = .x)   # fit a linear model predicting CH4 flux from pH_treatment for this soil type
    list(                                                 # return a list containing model and emmeans results
      model = lm_fit,                                     # store the fitted linear model
      emmeans = emmeans(lm_fit, pairwise ~ pH_treatment,  # compute estimated marginal means for pH_treatment and all pairwise comparisons
                        adjust = "none",                  # no multiple-comparison adjustment
                        level = 0.90)                     # set confidence level to 90%
    )                         
  }, keep = TRUE) %>%                                     # keep the grouping variable (soil_type) in the output list
  set_names(unique(exp_jars$soil_type))                   # assign list element names based on unique soil_type values

pH_H2O_CH4_models # print all model output

# Unamended soils model results 
summary(pH_H2O_CH4_models$Unamended$model) # display model summary (coefficients, R², etc.) for Unamended soils
anova(pH_H2O_CH4_models$Unamended$model) # ANOVA table 
pH_H2O_CH4_models$Unamended$emmeans # display emmeans and pairwise comparison results for Unamended soils             

# Unamended soils model results 
summary(pH_H2O_CH4_models$`Ground Rock`$model) # display model summary for Ground Rock soils
anova(pH_H2O_CH4_models$`Ground Rock`$model) # produce ANOVA table for Ground Rock soils model
pH_H2O_CH4_models$`Ground Rock`$emmeans # display emmeans and pairwise comparison results for Ground Rock soils              

```

```{r  pH & H2O exps CH4 fluxes - post-hoc pairwise comparisons and dynamically generate letters }

# Generate compact letter displays dynamically for each soil type
pH_H2O_CH4_letters <- map_df(names(pH_H2O_CH4_models), function(st) {
  
  # Get the fitted model for this soil type (e.g., "Unamended" or "Ground Rock")
  model <- pH_H2O_CH4_models[[st]]$model
  
  # Compute estimated marginal means (emmeans) and pairwise comparisons again
  emm <- emmeans(model, pairwise ~ pH_treatment, 
                 adjust = "none", # no p-value adjustment for multiple comparisons
                 level = 0.90)    # use 90% confidence intervals
  
  # Generate compact letter display (CLD)
  # - CLD assigns letters (a, b, c, ...) to treatment means
  # - Treatments sharing a letter are *not significantly different*
  # - Different letters indicate *significant differences* (α = 0.10 here)
  cld_df <- cld(emm, 
                adjust = "none",     # no adjustment for multiple testing
                Letters = letters,   # use lowercase letters for labeling
                alpha = 0.10,        # significance level 0.10 (matches 90% CI)
                sort = FALSE)        # keep treatments in their original order (i.e., don't assign "a" to the estimated mean with the largest magnitude (which is the default setting))
  
  # Prepare for plotting
  cld_df <- as.data.frame(cld_df)    # Convert CLD output to a data frame for easier manipulation
  cld_df$soil_type <- st             # Add soil type label to each row so you know which soil_type it belongs to
  cld_df$letters <- cld_df$.group    # Copy the assigned letter group (stored in `.group`) to a cleaner column name
  
  cld_df[, c("soil_type", "pH_treatment", "letters")]  # Keep only relevant columns for plotting or merging later
}) %>% 
  mutate(
    # Ensure consistent factor ordering for plotting and joining later
    soil_type    = factor(soil_type, levels = c("Unamended", "Ground Rock")),  
    pH_treatment = factor(pH_treatment, levels = c("Wet control", "5", "7", "8"))  
  )

# Join the letter groupings back to your summary dataset for plotting or reporting
summ_exp_letters <- summ_exp %>%
  left_join(pH_H2O_CH4_letters,
            by = c("soil_type", "pH_treatment")) # join based on soil type and pH treatment

```

```{r pH exp CH4 fluxes  - Create p-value annotations from model summaries}

# Extract and format p-values from each soil_type model for plotting or labeling
pH_H2O_CH4_pvals <- map_df(names(pH_H2O_CH4_models), function(st) {
  
  # Extract the fitted linear model object for this soil type
  model <- pH_H2O_CH4_models[[st]]$model
  
  # Run ANOVA on the model and extract the p-value for the first term (pH_treatment)
  # - anova(model) returns a table with F-values and p-values for each predictor
  pval  <- anova(model)$`Pr(>F)`[1]  # - `$'Pr(>F)'[1]` extracts the first p-value (for pH_treatment)
  
  # Create a one-row data frame for this soil type
  data.frame(
    soil_type = st,                              # store the soil type name
    label = paste0("p = ", signif(pval, 2))      # create a text label with the rounded p-value (2 significant digits)
  )
}) %>% 
  # Convert soil_type to an ordered factor for consistent plotting
  mutate(
    soil_type = factor(soil_type, levels = c("Unamended", "Ground Rock"))  # Relevel soil_type for plotting
  )

```

```{r pH exp CH4 fluxes  - plot CH4 conc means and lm stats results}

# --- Plot mean CH4 fluxes with error bars and post-hoc pairwise significance letters ---
pH_H2O_CH4_fluxes_means <- ggplot(summ_exp_letters,                              # use summary data joined with CLD letters
                                  aes(x = pH_treatment,                          # x-axis = pH treatment levels
                                      y = ng_CH4_per_g_dry_soil_per_day_mean,    # y-axis = mean CH4 flux
                                      fill = pH_treatment)) +                    # fill bars by pH treatment
  geom_col(position = "dodge", color = "black") +                                # draw bar plot with black outlines
  geom_errorbar(aes(ymin = ng_CH4_per_g_dry_soil_per_day_mean - ng_CH4_per_g_dry_soil_per_day_se,  # setting y max height for SE error bar 
                    ymax = ng_CH4_per_g_dry_soil_per_day_mean + ng_CH4_per_g_dry_soil_per_day_se), # setting y min height for SE error bar 
                width = 0.25,                                                    # width of error bar caps
                size = 0.3) +                                                    # thickness of error bars
  geom_text(aes(label = letters,                                                 # add significance letters using the letters column 
                y = ng_CH4_per_g_dry_soil_per_day_mean - 1.3*ng_CH4_per_g_dry_soil_per_day_se), # slightly below error bars for readability
            position = position_dodge(width = 0.8),                              # align with bar positions
            vjust = 0) +                                                         # text vertical adjustment
  facet_wrap2(~soil_type,                                                        # create separate panels for each soil type
              strip = strip_themed(                                              # customize facet label appearance
                background_x = elem_list_rect(fill = rep("gray95", 2)),          # specifying color of background of facet header 
                text_x = elem_list_text(color = rep("black", 2))                 # specifying color of text of facet header 
  )) +
  scale_fill_manual(values = c("darkgrey", "#66c2a5", "#fc8d62", "#8da0cb")) +   # custom bar colors
  theme_bw() +                                                                   # use a clean black-and-white theme
  labs(title = (bquote(CH[4]~Fluxes~with~pH~Treatment) ),                        # plot title with subscript formatting (CH₄)
       x = "pH Treatment",                                                       # x-axis label
       fill = "Soil pH Treatment") +                                             # legend title
  ylab(bquote(ng~CH[4]~g~soil^-1~day^-1) ) +                                     # y-axis label with scientific units
  theme(                                                                         # adjust text and title sizes for clarity
    plot.title = element_text(size = 20),
    axis.title = element_text(size = 14),
    axis.text = element_text(size = 12),
    legend.title = element_text(size = 14),
    legend.text = element_text(size = 12)
  ) 

# Display the plot
pH_H2O_CH4_fluxes_means

# Save plot as a PNG file with defined size to specified local file location 
ggsave(plot = pH_H2O_CH4_fluxes_means, filename = "figures/pH/fluxes/pH_AND_H2O_wetcontrol_CH4_fluxes_means_UNonly.png", width = 8, height = 5)

```

### CO2 fluxes (WITH wet control)


