---
title: "Keeling_plots"
author: "Ellery Vaughan"
date: "2024-20-02"
output:
  html_document:
    code_folding: hide
    toc: yes
    toc_depth: 3$
    toc_float: no
    df_print: kable 
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Making Keeling plots 

**Script Notes**
Script to make keeling plots for both pH and H2O experiments to estimate what the d13C-CO2 of the microbial respired CO2 is 

## pH Experiment 

```{r load libraries}

library(tidyverse)
library(readxl)
library(ggh4x)
library(ggtext)
library(wesanderson)

```


```{r reading in & prepping pH data}

raw <- read_xlsx("data/13CH_Incubation_Summary_AllData_10.21.25.xlsx", sheet="pH_exp")

data <- raw %>% 
  select(jar_num:sample_code,T1_CO2_ppm,T2_CO2_ppm,T1_d13C_permil,T2_d13C_permil) %>% 
  mutate(
    across(c(soil_type,pH_treatment,jar_type,rep), as.factor),
    across(c(T2_CO2_ppm,T2_d13C_permil), as.numeric),
    soil_type = factor(soil_type, levels = c("Unamended", "Ground Rock")),  # Relevel soil_type for plotting
    pH_treatment = fct_relevel(pH_treatment, c("Dry control","5","7","8") ),
    T1_CO2_ppm_inverse = 1/T1_CO2_ppm,
    T2_CO2_ppm_inverse = 1/T2_CO2_ppm
    ) 

data <- data %>%
  pivot_longer(
    cols = c(T1_CO2_ppm, T2_CO2_ppm, T1_d13C_permil, T2_d13C_permil, T1_CO2_ppm_inverse, T2_CO2_ppm_inverse),
    names_to = c("timepoint", "variable"),
    names_pattern = "^(T\\d+)_(.*)$",   # Capture T1/T2 as timepoint and the rest as variable
    values_to = "value"
  )

data <- data %>%
  pivot_wider(
    names_from = variable,
    values_from = value
  )

data.plot <- data %>% 
  filter(jar_type == "Exp") 

```

```{r all soils on one keeling plot}


K_all <- ggplot(data.plot, aes(x=CO2_ppm_inverse, y=d13C_permil, color = timepoint) ) +
  geom_point() +
  theme_bw() +
  stat_smooth(method = 'lm', se = FALSE, color = "black") +
  labs(title = "Keeling plot for all samples",
       y = "*&delta;*<sup>13</sup>C of CO<sub>2</sub> (&permil;)",
       x = "1/[CO<sub>2</sub>] (ppm<sup>-1</sup>)") +
  theme(
    axis.title.y = element_markdown(),
    axis.title.x = element_markdown()
  )

K_all

ggsave(plot = K_all, filename = "figures/isotopes/keeling/all.png", width = 9, height = 6.5)


K_all_lm <- lm(d13C ~ CO2_inverse, data = data2_fig)
summary(K_all_lm )
tab_model(K_all_lm) 


```

```{r individual soil & pH treatment combo plots}

library(ggplot2)
library(dplyr)

# Loop through combinations of soil type and pH treatment
for (s in unique(data.plot$soil_type)) {
  for (p in unique(data.plot$pH_treatment)) {
    
    # Subset data
    subset_data <- data.plot %>%
      filter(soil_type == s, pH_treatment == p)
    
    # Fit linear model
    model <- lm(d13C_permil ~ CO2_ppm_inverse, data = subset_data)
    
    # Extract coefficients
    intercept <- coef(model)[1]
    slope <- coef(model)[2]
    r2 <- summary(model)$r.squared
    
    # Create text label for equation
    # eqn <- sprintf("y = %.3f x + %.3f\nR² = %.3f", slope, intercept, r2) text showing the full equation and R2
    eqn <- sprintf("y-intercept = %.2f", intercept)
    
    # Make plot
    p_plot <- ggplot(subset_data, aes(x = CO2_ppm_inverse, y = d13C_permil, color = timepoint)) +
      geom_point() +
      stat_smooth(method = "lm", se = FALSE, color = "black") +
      labs(
        title = paste0("Keeling plot - ", "Soil: ", s, " pH: ", p),
        y = "*&delta;*<sup>13</sup>C of CO<sub>2</sub> (&permil;)",
        x = "1/[CO<sub>2</sub>] (ppm<sup>-1</sup>)"
      ) +
      scale_color_manual(values=wes_palette("Darjeeling1", 2) ) +
      theme_bw() +
      theme(
        axis.title.y = element_markdown(),
        axis.title.x = element_markdown(),
        plot.title = element_text(hjust = 0.5,size = 20), # Title text size
        # axis.title.x = element_text(size = 14),      # X-axis title text size
        # axis.title.y = element_text(size = 14),      # Y-axis title text size
        axis.text.x = element_text(size = 12),       # X-axis text size
        axis.text.y = element_text(size = 12),       # Y-axis text size
        legend.title = element_text(size = 14),      # Legend title text size
        legend.text = element_text(size = 12),        # Legend text size
      ) +
      annotate(
        "label",
        # x = Inf, y = -Inf,          # place in bottom-right corner
        x = min(subset_data$CO2_ppm_inverse, na.rm = TRUE) + 0.05 * diff(range(subset_data$CO2_ppm_inverse, na.rm = TRUE)),
        y = min(subset_data$d13C_permil, na.rm = TRUE) + 0.05 * diff(range(subset_data$d13C_permil, na.rm = TRUE)),
        label = eqn,
        hjust = 0, vjust = 0,
        size = 3.5,
        color = "black",
        fill = "white",
        label.size = 0.3
      ) +
      labs(color = "Timepoint")
    
    # Save each plot
    filename <- sprintf("figures/isotopes/keeling/Keeling_%s_pH%s.png", s, p)
    ggsave(filename, p_plot, width = 9, height = 6.5)
  }
}

```

```{r dobule checking y-intercepts}

lm <- lm(d13C_permil ~ CO2_ppm_inverse,
         data = subset(data.plot, soil_type == "Ground Rock" & pH_treatment == "Dry control"))
summary(lm)

```


## Keeling plots for H2O exp 

```{r reading in & prepping H2O data}

raw <- read_xlsx("data/13CH_Incubation_Summary_AllData_10.21.25.xlsx", sheet="H2O_exp")

data <- raw %>% 
  select(jar_num:sample_code,T1_CO2_ppm,T2_CO2_ppm,T1_d13C_permil,T2_d13C_permil) %>% 
  mutate(
    across(c(soil_type,H2O_treatment,jar_type,rep), as.factor),
    across(c(T2_CO2_ppm,T2_d13C_permil), as.numeric),
    soil_type = factor(soil_type, levels = c("Unamended", "Ground Rock")),  # Relevel soil_type for plotting
    pH_treatment = fct_relevel(H2O_treatment, c("no","yes") ),
    T1_CO2_ppm_inverse = 1/T1_CO2_ppm,
    T2_CO2_ppm_inverse = 1/T2_CO2_ppm
    ) 

data <- data %>%
  pivot_longer(
    cols = c(T1_CO2_ppm, T2_CO2_ppm, T1_d13C_permil, T2_d13C_permil, T1_CO2_ppm_inverse, T2_CO2_ppm_inverse),
    names_to = c("timepoint", "variable"),
    names_pattern = "^(T\\d+)_(.*)$",   # Capture T1/T2 as timepoint and the rest as variable
    values_to = "value"
  )

data <- data %>%
  pivot_wider(
    names_from = variable,
    values_from = value
  )

data.plot <- data %>% 
  filter(jar_type == "Exp") 

```

```{r individual soil & H2O treatment combo plots}

library(ggplot2)
library(dplyr)

# Loop through combinations of soil type and pH treatment
for (s in unique(data.plot$soil_type)) {
  for (t in unique(data.plot$H2O_treatment)) {
    
    # Subset data
    subset_data <- data.plot %>%
      filter(soil_type == s, H2O_treatment == t)
    
    # Fit linear model
    model <- lm(d13C_permil ~ CO2_ppm_inverse, data = subset_data)
    
    # Extract coefficients
    intercept <- coef(model)[1]
    slope <- coef(model)[2]
    r2 <- summary(model)$r.squared
    
    # Create text label for equation
    # eqn <- sprintf("y = %.3f x + %.3f\nR² = %.3f", slope, intercept, r2) text showing the full equation and R2
    eqn <- sprintf("y-intercept = %.2f", intercept)
    
    # Make plot
    p_plot <- ggplot(subset_data, aes(x = CO2_ppm_inverse, y = d13C_permil, color = timepoint)) +
      geom_point() +
      stat_smooth(method = "lm", se = FALSE, color = "black") +
      labs(
        title = paste0("Keeling plot - ", "Soil: ", s, " H2O: ", t),
        y = "*&delta;*<sup>13</sup>C of CO<sub>2</sub> (&permil;)",
        x = "1/[CO<sub>2</sub>] (ppm<sup>-1</sup>)"
      ) +
      scale_color_manual(values=wes_palette("Darjeeling1", 2) ) +
      theme_bw() +
      theme(
        axis.title.y = element_markdown(),
        axis.title.x = element_markdown(),
        plot.title = element_text(hjust = 0.5,size = 20), # Title text size
        # axis.title.x = element_text(size = 14),      # X-axis title text size
        # axis.title.y = element_text(size = 14),      # Y-axis title text size
        axis.text.x = element_text(size = 12),       # X-axis text size
        axis.text.y = element_text(size = 12),       # Y-axis text size
        legend.title = element_text(size = 14),      # Legend title text size
        legend.text = element_text(size = 12),        # Legend text size
      ) +
      annotate(
        "label",
        # x = Inf, y = -Inf,          # place in bottom-right corner
        x = min(subset_data$CO2_ppm_inverse, na.rm = TRUE) + 0.05 * diff(range(subset_data$CO2_ppm_inverse, na.rm = TRUE)),
        y = min(subset_data$d13C_permil, na.rm = TRUE) + 0.05 * diff(range(subset_data$d13C_permil, na.rm = TRUE)),
        label = eqn,
        hjust = 0, vjust = 0,
        size = 3.5,
        color = "black",
        fill = "white"
      ) +
      labs(color = "Timepoint")
    
    # Save each plot
    filename <- sprintf("figures/isotopes/keeling/Keeling_%s_H2O%s.png", s, t)
    ggsave(filename, p_plot, width = 9, height = 6.5)
  }
}


```

```{r}

lm <- lm(d13C_permil ~ CO2_ppm_inverse,
         data = subset(data.plot, soil_type == "Ground Rock" & H2O_treatment == "no"))
summary(lm)

```


## Keeling plot intercepts summary figure 
```{r keeling plot intercepts on one figure}
raw3 <- readxl::read_xlsx("../data/KeelingPlot_Intercepts.xlsx", sheet = "Sheet1")

data3 <- raw3 %>% 
  mutate(soil_type = as.factor(soil_type),
         pH_treatment = as.factor(pH_treatment) ) %>% 
  mutate(pH_treatment = fct_relevel(pH_treatment, c("control","5","7","8") ) )

intest <- data3 %>% 
  filter(pH_treatment != "control")

mean(intest$d13C_CO2)

Kp_Is <- ggplot(data3, aes(x=pH_treatment,y=d13C_CO2, color = pH_treatment) ) +
  geom_point() +
  facet_wrap(~soil_type) +
  theme_bw() +
  scale_fill_manual(values=c("darkgrey", "#a6cee3", "#1f78b4", "#b2df8a")) +
  scale_color_manual(values=c("darkgrey", "#a6cee3", "#1f78b4", "#b2df8a")) +
  labs(title = "Keeling plot intercepts by soil type and pH treatment",
       y = "*&delta;*<sup>13</sup>C-CO<sub>2</sub> (&permil;)",
       x = "pH Treatment") +
       # y = "*&delta;*<sup>23</sup>C<sub>DIC</sub> (&permil; VPDB)") +
  # xlab(bquote("["~CO[2]~"]"^-2~"("~ppm^-2~")") ) +
  theme(
    axis.title.y = element_markdown() 
    ) 

ggsave(plot = Kp_Is, filename = "../figures/Keeling/Keelingplot_intercepts.png", width = 7, height = 4)
```

## Looking at averages of d13C of CO2 from CH4-CO2 flux values 
```{r averages of d13C of CO2 from CH4-CO2 flux values }
raw4 <- readxl::read_xlsx("../data/Isotope mass balance equation sheet.xlsx", sheet = "Sheet1")

data4 <- raw4 %>%  
  filter(jar_type == "Exp") %>% 
  mutate(soil_type = as.factor(soil_type),
         pH_treatment = as.factor(pH_treatment),
         rep = as.factor(rep),
         jar_type = as.factor(jar_type),
         delta13C_of_CO2_of_CH4_to_CO2 = as.numeric(delta13C_of_CO2_of_CH4_to_CO2) ) %>% 
  mutate(pH_treatment = fct_relevel(pH_treatment, c("control","5","7","8") ) )

summary4 <- data4 %>% 
  filter(jar_type == "Exp") %>% 
  group_by(soil_type, pH_treatment) %>% 
  summarise(mean = mean(atom_perc_of_CCO2_from_CH4_to_CO2, na.rm = TRUE),
            min = min(atom_perc_of_CCO2_from_CH4_to_CO2, na.rm = TRUE),
            max = max(atom_perc_of_CCO2_from_CH4_to_CO2, na.rm = TRUE),
            sd = sd(atom_perc_of_CCO2_from_CH4_to_CO2, na.rm = TRUE),
            n = length(atom_perc_of_CCO2_from_CH4_to_CO2),
            se = sd/sqrt(n))

```

```{r plotting the data}
# plotting the data

atomperc_means <- ggplot() +
  geom_point(data=data4, aes(x=pH_treatment,y=atom_perc_of_CCO2_from_CH4_to_CO2, color = pH_treatment), size =2 ) +
  geom_point(data=summary4, aes(x=pH_treatment,y=mean), color = "red", size = 2 ) +
  geom_errorbar(data=summary4, aes(x=pH_treatment, ymin = mean-se, ymax = mean+se), width=0.25, size=.3 ) +
  facet_wrap(~soil_type) +
  theme_classic() +
  scale_fill_manual(values=c("darkgrey", "#a6cee3", "#1f78b4", "#b2df8a")) +
  scale_color_manual(values=c("darkgrey", "#a6cee3", "#1f78b4", "#b2df8a")) +
  labs(y = bquote("Atom %" ^13*"C-CO"[2]),
       x = "pH Treatment") +
  theme(
  plot.title = element_text(size = 20),        # Title text size
  axis.title.x = element_text(size = 14),      # X-axis title text size
  axis.title.y = element_text(size = 14),      # Y-axis title text size
  axis.text.x = element_text(size = 12),       # X-axis text size
  axis.text.y = element_text(size = 12),       # Y-axis text size
  legend.title = element_text(size = 14),      # Legend title text size
  legend.text = element_text(size = 12)        # Legend text size
) +
  labs(color = "Soil pH Treatment")

  
 ggsave(plot = atomperc_means, filename = "../figures/d13C/atomperc_means.png", width = 7, height = 3)
```

## Statistics 

##### Control soils  
Sample timepoint 1 - All different from control and each other 
```{r CO2 initial}
CO2_CT <- data4 %>% 
  filter(soil_type == "Control") 

CO2_CT_I_lm <- lm(atom_perc_of_CCO2_from_CH4_to_CO2 ~ pH_treatment, data = CO2_CT)

autoplot(CO2_CT_I_lm, which=2) 
autoplot(CO2_CT_I_lm)
anova(CO2_CT_I_lm) # there is a difference among treatment groups # p-value < 0.001
summary(CO2_CT_I_lm)
tab_model(CO2_CT_I_lm)

t1 <- emmeans::emmeans(CO2_CT_I_lm , pairwise ~ pH_treatment)
```

```{r CO2 initial}
CO2_CT <- data4 %>% 
  filter(soil_type == "Ground Rock") 

CO2_CT_I_lm <- lm(atom_perc_of_CCO2_from_CH4_to_CO2 ~ pH_treatment, data = CO2_CT)

autoplot(CO2_CT_I_lm, which=2) 
autoplot(CO2_CT_I_lm)
anova(CO2_CT_I_lm) # there is a difference among treatment groups # p-value < 0.001
summary(CO2_CT_I_lm)
tab_model(CO2_CT_I_lm)

t1 <- emmeans::emmeans(CO2_CT_I_lm , pairwise ~ pH_treatment)
```
